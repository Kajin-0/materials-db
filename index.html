<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;meta charset="UTF-8" /&gt;
&lt;title&gt;MaterialsDB&lt;/title&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
&lt;!-- Link the CSS file --&gt;
&lt;link rel="stylesheet" href="style.css" /&gt;
&lt;!-- Optional: Placeholder favicon --&gt;
&lt;link rel="icon" href="data:;base64,iVBORw0KGgo="&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;header&gt;
&lt;h1 onclick="window.location.reload()" title="Reload MaterialsDB" style="cursor:pointer;"&gt;MaterialsDB&lt;/h1&gt;
&lt;/header&gt;

&lt;div id="search-container"&gt;
&lt;input id="searchInput" type="text" placeholder="Search materials by name, formula, tag..." autocomplete="off" /&gt;
&lt;ul id="suggestions"&gt;&lt;/ul&gt;
&lt;/div&gt;

&lt;section class="toolbar" id="toolbar"&gt;
&lt;div class="filter-group"&gt;
&lt;label for="industryFilter"&gt;Industry:&lt;/label&gt;
&lt;select id="industryFilter" disabled&gt;
&lt;option value=""&gt;Loading...&lt;/option&gt;
&lt;/select&gt;
&lt;/div&gt;
&lt;div class="filter-group"&gt;
&lt;label for="categoryFilter"&gt;Category:&lt;/label&gt;
&lt;select id="categoryFilter" disabled&gt;
&lt;option value=""&gt;Loading...&lt;/option&gt;
&lt;/select&gt;
&lt;/div&gt;
&lt;div class="filter-group"&gt;
&lt;label for="propertyFilter"&gt;Tag:&lt;/label&gt;
&lt;select id="propertyFilter" disabled&gt;
&lt;option value=""&gt;Loading...&lt;/option&gt;
&lt;/select&gt;
&lt;/div&gt;
&lt;/section&gt;

&lt;main id="results"&gt;
&lt;p style="text-align: center; color: #999;"&gt;Initializing database...&lt;/p&gt;
&lt;/main&gt;

&lt;!-- Load Fuse.js library from CDN --&gt;
&lt;script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"&gt;&lt;/script&gt;

&lt;!-- === EMBEDDED app.js CODE START === --&gt;
&lt;script&gt;
// Force redeploy test (Comment from previous attempt, harmless here)

// Global variables
let allMaterialsData = []; // Holds combined data
let fuse; // Fuse.js instance

// --- Core Data Loading ---

// Fetches and parses a single JSON file
async function fetchJson(url) {
console.log(`Attempting to fetch: ${url}`);
try {
const response = await fetch(url);
if (!response.ok) {
if (response.status === 404) {
// This is expected for files not yet created, log as warning
console.warn(`Source file not found (404): ${url}`);
} else {
// Log other fetch errors more prominently
console.error(`Fetch Error for ${url}: ${response.status} ${response.statusText}`);
}
return null; // Indicate failure
}
// Try parsing JSON
try {
const data = await response.json();
// **Crucial Check:** Ensure the data from source files is an array
if (!Array.isArray(data)) {
console.error(`Data format error: Content of ${url} is not a JSON array.`);
return null; // Treat non-array content as an error
}
console.log(`Successfully fetched and parsed: ${url}`);
return data;
} catch (parseError) {
console.error(`JSON Parse Error in ${url}:`, parseError);
return null; // Indicate failure due to parsing error
}
} catch (networkError) {
console.error(`Network Error fetching ${url}:`, networkError);
return null; // Indicate failure
}
}

// Loads index, fetches all sources, initializes Fuse.js and UI
async function initializeDatabase() {
const resultsContainer = document.getElementById("results");
updateLoadingMessage("Loading material index...");
console.log("Initializing database...");

// Use relative path for index within the same deployment structure
const indexData = await fetchJson('./data/materials-index.json');

if (!indexData || !indexData.sources || !Array.isArray(indexData.sources)) {
console.error("Failed to load or invalid format: ./data/materials-index.json. Expected { \"sources\": [...] }");
updateLoadingMessage("Error: Could not load material index. Check console (F12).", true);
disableFilters();
return;
}

updateLoadingMessage(`Loading ${indexData.sources.length} source files...`);
console.log("Index loaded. Sources:", indexData.sources);

const fetchPromises = indexData.sources
.filter(sourceFile =&gt; typeof sourceFile === 'string' &amp;&amp; sourceFile.endsWith('.json')) // Ensure valid entries
.map(sourceFile =&gt; fetchJson(`./data/${sourceFile}`)); // Use relative path for sources

if (fetchPromises.length !== indexData.sources.length) {
console.warn("Some entries in materials-index.json sources were invalid filenames.");
}

if (fetchPromises.length === 0) {
console.error("No valid source files listed in materials-index.json.");
updateLoadingMessage("Error: No valid source files found in index. Check console (F12).", true);
disableFilters();
return;
}

try {
const results = await Promise.all(fetchPromises);

allMaterialsData = results.filter(data =&gt; data !== null).flat();

console.log(`Total materials loaded after filtering and flattening: ${allMaterialsData.length}`);

if (allMaterialsData.length === 0) {
console.error("Failed to load any valid material data from source files.");
updateLoadingMessage("Error: No material data loaded. Check source files and console (F12).", true);
disableFilters();
return;
}

updateLoadingMessage("Initializing search index...");

try {
fuse = new Fuse(allMaterialsData, {
keys: ["name", "formula", "synonyms", "tags"],
threshold: 0.3,
includeScore: true,
ignoreLocation: true,
});
console.log("Fuse.js initialized successfully.");
} catch (fuseError) {
console.error("Error initializing Fuse.js:", fuseError);
updateLoadingMessage("Error: Failed to initialize search index. Check console (F12).", true);
disableFilters();
return;
}

updateLoadingMessage("Updating filters...");
updateFilters(allMaterialsData);

updateLoadingMessage(""); // Clear loading message
performSearch("");
console.log("Database initialization complete.");

} catch (error) {
console.error("Unexpected error during source file processing:", error);
updateLoadingMessage("Error: Failed to process material data. Check console (F12).", true);
disableFilters();
}
}

// --- UI and Filtering ---

function updateLoadingMessage(message, isError = false) {
const resultsContainer = document.getElementById("results");
// Ensure container exists before trying to update it
if (!resultsContainer) {
console.error("Cannot update loading message: #results container not found.");
return;
}
if (message) {
resultsContainer.innerHTML = `&lt;p style="text-align: center; color: ${isError ? 'red' : '#777'};"&gt;${message}&lt;/p&gt;`;
} else {
if (!resultsContainer.querySelector('p[style*="color: red"]')) {
resultsContainer.innerHTML = '';
}
}
}

function disableFilters() {
try {
document.getElementById("industryFilter").disabled = true;
document.getElementById("categoryFilter").disabled = true;
document.getElementById("propertyFilter").disabled = true;
console.log("Filters disabled due to error.");
} catch (e) { console.error("Error disabling filters:", e); }
}


function updateFilters(materials) {
try {
const industrySelect = document.getElementById("industryFilter");
const categorySelect = document.getElementById("categoryFilter");
const propertySelect = document.getElementById("propertyFilter");

if (!industrySelect || !categorySelect || !propertySelect) {
console.error("Filter select elements not found in the DOM.");
return;
}

industrySelect.disabled = false;
categorySelect.disabled = false;
propertySelect.disabled = false;

const industries = [...new Set(materials.flatMap(m =&gt; (m.tags || []).filter(t =&gt; typeof t === 'string' &amp;&amp; t.startsWith("industry:")).map(t =&gt; t.replace("industry:", ""))))].sort();
const categories = [...new Set(materials.map(m =&gt; m.category).filter(Boolean))].sort();
const tags = [...new Set(materials.flatMap(m =&gt; (m.tags || []).filter(t =&gt; typeof t === 'string' &amp;&amp; !t.startsWith("industry:"))))].sort();

function fill(sel, items) {
sel.innerHTML = "&lt;option value=''&gt;All&lt;/option&gt;" + items.map(i =&gt; `&lt;option value="${i}"&gt;${i}&lt;/option&gt;`).join("");
}

fill(industrySelect, industries);
fill(categorySelect, categories);
fill(propertySelect, tags);
console.log("Filters updated and enabled.");
} catch (error) {
console.error("Error updating filters:", error);
updateLoadingMessage("Error: Failed to update filters. Check console (F12).", true);
disableFilters();
}
}

function performSearch(query) {
console.log(`Performing search. Query: "${query}"`);
const resultsContainer = document.getElementById("results");

if (!fuse) {
console.warn("Search called before Fuse.js was initialized.");
if (resultsContainer &amp;&amp; !resultsContainer.querySelector('p[style*="color: red"]')) {
updateLoadingMessage("Database loading, please wait...", false);
}
return;
}

const industryFilter = document.getElementById("industryFilter");
const categoryFilter = document.getElementById("categoryFilter");
const propertyFilter = document.getElementById("propertyFilter");
const industry = industryFilter ? industryFilter.value : "";
const category = categoryFilter ? categoryFilter.value : "";
const tag = propertyFilter ? propertyFilter.value : "";

const toolbar = document.getElementById("toolbar");
if (toolbar) {
toolbar.classList.toggle("active", query.trim() !== "" || industry || category || tag);
}

let results = [];
if (query.trim() === "") {
results = allMaterialsData;
console.log(`Query empty, starting with ${results.length} total materials.`);
} else {
console.log(`Executing Fuse search for "${query}"...`);
const fuseResults = fuse.search(query);
results = fuseResults.map(x =&gt; x.item);
console.log(`Fuse search returned ${results.length} initial matches.`);
}

const initialCount = results.length;
if (industry) {
results = results.filter(m =&gt; m.tags &amp;&amp; Array.isArray(m.tags) &amp;&amp; m.tags.includes("industry:" + industry));
console.log(`After industry filter ('${industry}'): ${results.length} materials remaining.`);
}
if (category) {
results = results.filter(m =&gt; m.category === category);
console.log(`After category filter ('${category}'): ${results.length} materials remaining.`);
}
if (tag) {
results = results.filter(m =&gt; m.tags &amp;&amp; Array.isArray(m.tags) &amp;&amp; m.tags.includes(tag));
console.log(`After tag filter ('${tag}'): ${results.length} materials remaining.`);
}
if (industry || category || tag) {
console.log(`Filtering reduced results from ${initialCount} to ${results.length}.`);
}

render(results);
}

function render(materials) {
const out = document.getElementById("results");
if (!out) {
console.error("Results container (#results) not found.");
return;
}
out.innerHTML = "";

if (!materials || materials.length === 0) {
console.log("Render: No materials to display.");
return;
}

console.log(`Render: Displaying ${materials.length} material cards.`);
const fragment = document.createDocumentFragment();
for (const m of materials) {
const el = document.createElement("div");
el.className = "material-card";
const name = m.name || 'Unnamed Material';
const formula = m.formula || 'N/A';
const category = m.category || 'N/A';
const tagsHtml = Array.isArray(m.tags)
? m.tags.filter(t =&gt; typeof t === 'string').map(t =&gt; `&lt;span class='tag'&gt;${t}&lt;/span&gt;`).join(" ")
: '';

el.innerHTML = `
&lt;h2&gt;${name}&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Formula:&lt;/strong&gt; ${formula}&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Category:&lt;/strong&gt; ${category}&lt;/p&gt;
&lt;div class="tags"&gt;${tagsHtml}&lt;/div&gt;
`;
fragment.appendChild(el);
}
out.appendChild(fragment);
}

function showSuggestions(query) {
const ul = document.getElementById("suggestions");
if (!ul) return;
ul.innerHTML = "";

if (!fuse) {
console.warn("Suggestions requested before Fuse was ready.");
return;
}

try {
const results = fuse.search(query, { limit: 8 });
const suggestionItems = results.map(x =&gt; x.item);

if (suggestionItems.length &gt; 0) {
suggestionItems.forEach(item =&gt; {
if (!item || !item.name) return;
const li = document.createElement("li");
li.textContent = item.name;
li.addEventListener("mousedown", (e) =&gt; {
e.preventDefault();
const searchInput = document.getElementById("searchInput");
if(searchInput) searchInput.value = item.name;
ul.innerHTML = "";
performSearch(item.name);
});
ul.appendChild(li);
});
}
} catch (error) {
console.error("Error during suggestion generation:", error);
}
}

// --- Event Listeners Setup ---
document.addEventListener("DOMContentLoaded", () =&gt; {
console.log("DOM fully loaded. Initializing...");
initializeDatabase(); // Start the process

const searchInput = document.getElementById("searchInput");
const suggestionsList = document.getElementById("suggestions");
const resultsContainer = document.getElementById("results");
const industryFilter = document.getElementById("industryFilter");
const categoryFilter = document.getElementById("categoryFilter");
const propertyFilter = document.getElementById("propertyFilter");

if (!searchInput || !suggestionsList || !resultsContainer || !industryFilter || !categoryFilter || !propertyFilter) {
console.error("One or more essential DOM elements are missing. Check HTML IDs.");
updateLoadingMessage("Error: Page structure incorrect. Cannot initialize.", true);
return;
}

searchInput.addEventListener("input", () =&gt; {
const query = searchInput.value.trim();
if (query) {
showSuggestions(query);
} else {
suggestionsList.innerHTML = "";
performSearch("");
}
});

searchInput.addEventListener("keydown", e =&gt; {
if (e.key === "Enter") {
e.preventDefault();
const query = searchInput.value.trim();
suggestionsList.innerHTML = "";
performSearch(query);
}
});

searchInput.addEventListener("blur", () =&gt; {
setTimeout(() =&gt; {
if (document.activeElement !== searchInput) {
suggestionsList.innerHTML = "";
}
}, 150);
});

searchInput.addEventListener("focus", () =&gt; {
if (searchInput.value.trim()) {
showSuggestions(searchInput.value.trim());
}
});

industryFilter.addEventListener("change", () =&gt; performSearch(searchInput.value.trim()));
categoryFilter.addEventListener("change", () =&gt; performSearch(searchInput.value.trim()));
propertyFilter.addEventListener("change", () =&gt; performSearch(searchInput.value.trim()));

resultsContainer.addEventListener("click", (event) =&gt; {
if (event.target.classList.contains("tag")) {
const clickedTag = event.target.textContent;
console.log("Tag clicked:", clickedTag);

const industryPrefix = "industry:";
let searchTriggered = false;

if (clickedTag.startsWith(industryPrefix)) {
const industry = clickedTag.substring(industryPrefix.length);
if ([...industryFilter.options].some(opt =&gt; opt.value === industry)) {
if (industryFilter.value !== industry) {
industryFilter.value = industry;
searchTriggered = true;
}
if (propertyFilter.value !== "") {
propertyFilter.value = "";
searchTriggered = true;
}
} else { console.warn(`Industry filter option not found: ${industry}`); }
} else {
if ([...propertyFilter.options].some(opt =&gt; opt.value === clickedTag)) {
if (propertyFilter.value !== clickedTag) {
propertyFilter.value = clickedTag;
searchTriggered = true;
}
if (industryFilter.value !== "") {
industryFilter.value = "";
searchTriggered = true;
}
} else { console.warn(`Property filter option not found: ${clickedTag}`); }
}

if (searchTriggered) {
performSearch(searchInput.value.trim());
}
}
});
});
&lt;/script&gt;
&lt;!-- === EMBEDDED app.js CODE END === --&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>
